{% extends '/base/style/base.html' %}
{% set static_url = '/static' %}

{% block navbar %}
    {% include 'base/style/navbar-admin.html' %}
{% endblock %}

{% block content %}

<!---- ============================ Page Title Start ================================== ---->
<div class="page-title">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12">
                <h2 class="ipt-title">Contact Form</h2>
                <span class="ipn-subtitle">Update contact form query status</span>
            </div>
        </div>
    </div>
</div>


<!---- ============================ Page Title End ================================== ---->

<!---- ============================ User Dashboard ================================== ---->
<section class="bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-12 pe-xl-4">
                
                <div class="simple-sidebar sm-sidebar">
                    
                    <div class="sidebar-widgets">
                        <div class="dashboard-navbar">
                            
                            <div class="d-user-avater">
                                <img src="{{ url_for('static', filename='profile/default.webp') }}" class="img-fluid avater" alt=""/>
                                <h4>Hi, Admin</h4>
                            </div>
                            
                            <div class="d-navigation">
                                <ul>    
                                    {% include '/base/menu/admin-page-and-mobile.html' %}
                                </ul>
                            </div>
                            
                        </div>
                    </div>
                    
                </div>
            </div>

            <div class="col-lg-9 col-md-12">

                <div class="row">

                    <div class="col-lg-6 col-md-6 col-sm-12">
                        <div class="dashboard-stat widget-4">
                            <div class="dashboard-stat-content">
                                <h4>{{ total_member_request }}</h4>
                                <span>Total Query</span>
                            </div>
                            <div class="dashboard-stat-icon">
                                <i class="bi bi-envelope-check"></i>
                            </div>
                        </div>    
                    </div>

                    <div class="col-lg-6 col-md-6 col-sm-12">
                        <div class="dashboard-stat widget-5">
                            <div class="dashboard-stat-content">
                                <h4>{{ total_not_solved }}</h4>
                                <span>Not Solved or Pending Query</span>
                            </div>
                            <div class="dashboard-stat-icon">
                                <i class="bi bi-envelope-exclamation"></i>
                            </div>
                        </div>    
                    </div>

                </div>

                <div class="dashboard-wraper mb-3">
                    <h3 class="mb-0">Exchange Request</h3>
                </div>

                <div class="dashboard-wraper mb-3 p-3">
                    <!-- Fixed search bar -->
                    <div style="margin-bottom: 15px;" class="float-end">
                        <input type="text" id="userSearchInput" placeholder="Search"
                            style="padding: 8px; width: 250px; border-radius: 5px; border: 1px solid #ccc;">
                    </div>

                    <!-- Scrollable table -->
                    <div style="max-height: 100vh; max-width: 100%; overflow: auto; clear: both;">
                        <table cellpadding="10" cellspacing="0" style="width: 100%; min-width: max-content;">
                            <thead>
                                <tr>
                                    <th>S. No.</th>
                                    <th>Home Details</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Guest Point</th>
                                    <th>User Type</th>
                                    <th>House Status</th>
                                    <th>Message</th>
                                    <th>Date & Time</th>
                                    <th>Query Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if exchange_requests %}
                                    {% for req in exchange_requests %}
                                        <tr style="height: 100px;" class="{% if req.query_status == 'Solved' %}bg-light-success{% endif %}">
                                            <td>{{ loop.index }}</td>
                                            <td>
                                                <button class="btn btn-sm border view-user-details" data-user-id="{{ req.user_id }}" type="button">View</button>
                                            </td>
                                            <td>{{ req.name or '----' }}</td>
                                            <td>{{ req.email or '----' }}</td>
                                            <td>{{ req.phone or '----' }}</td>
                                            <td>{{ req.guest_point or '0' }}</td>
                                            <td>{{ req.user_type or '----' }}</td>
                                            <td>{{ req.house_status or '----' }}</td>
                                            <td>{{ req.message or '----' }}</td>
                                            <td>{{ req.submitted_at or '----' }}</td>
                                            <td>
                                                <form method="POST" action="{{ url_for('exchange_request') }}">
                                                    <input type="hidden" name="user_id" value="{{ req.user_id }}">
                                                    <input type="hidden" name="request_id" value="{{ req.request_id }}">

                                                    <div class="membership-form">
                                                        <select name="dropdown_option" required class="form-select">
                                                            <option value="" disabled {% if not req.query_status %}selected{% endif %}>Select Status</option>
                                                            <option value="Solved" {% if req.query_status == 'Solved' %}selected{% endif %}>Solved</option>
                                                            <option value="Not Solved" {% if req.query_status == 'Not Solved' %}selected{% endif %}>Not Solved</option>
                                                            <option value="Pending" {% if req.query_status == 'Pending' %}selected{% endif %}>Pending</option>
                                                        </select>
                                                        <button type="submit" class="btn btn-main">
                                                            <i class="bi bi-check-circle me-2"></i>Update
                                                        </button>
                                                    </div>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8">No exchange requests found.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!---- ============================ User Dashboard End ================================== ---->

<script>
document.getElementById("userSearchInput").addEventListener("keyup", function() {
    let filter = this.value.toLowerCase();
    let rows = document.querySelectorAll("table tbody tr");

    rows.forEach(function(row) {
        let text = row.textContent.toLowerCase();
        if (text.includes(filter)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});
</script>
<script>
    document.querySelectorAll('.view-user-details').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.getAttribute('data-user-id');

            fetch(`/get-user-details/${userId}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.status === "success") {
                        const user = data.user;
                        Swal.fire({
                            title: `<strong>Home Details</strong>`,
                            html: `
                                <p><strong>Name:</strong> ${user.name}</p>
                                <p><strong>Email:</strong> ${user.email}</p>
                                <p><strong>Phone:</strong> ${user.phone}</p>
                                <p><strong>Home Title:</strong> ${user.properties.title}</p>
                                <p><strong>Guest Points:</strong> ${user.properties.guest_points}</p>
                            `,
                            confirmButtonText: 'Close'
                        });
                    } else {
                        Swal.fire("Error", "User details not found.", "error");
                    }
                })
                .catch(err => {
                    console.error(err);
                    Swal.fire("Error", "Something went wrong while fetching user details.", "error");
                });
        });
    });
</script>

{% endblock %}